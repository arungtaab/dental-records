<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Student Dental Records - Complete System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="https://arungtaab.github.io/dental-records/" />
    <link rel="manifest" href="manifest.webmanifest">
    <style>
        :root {
            --caribbean-current: #16697aff;
            --moonstone: #489fb5ff;
            --sky-blue: #82c0ccff;
            --isabelline: #ede7e3ff;
            --orange-peel: #ffa62bff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--caribbean-current);
            background: linear-gradient(135deg, var(--moonstone) 0%, var(--caribbean-current) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--isabelline);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: var(--isabelline);
            color: var(--caribbean-current);
            padding: 40px 30px;
            text-align: center;
            border-bottom: 2px solid var(--sky-blue);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .search-section, .results-section {
            margin-bottom: 30px;
        }
        
        h2 {
            color: var(--caribbean-current);
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 600;
        }
        
        h3 {
            color: var(--caribbean-current);
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        h4 {
            color: var(--caribbean-current);
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        h5 {
            color: var(--caribbean-current);
            margin-bottom: 12px;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--caribbean-current);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--sky-blue);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--isabelline);
            color: var(--caribbean-current);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--moonstone);
            box-shadow: 0 0 0 3px rgba(72, 159, 181, 0.1);
            transform: translateY(-2px);
        }
        
        .btn {
            background: linear-gradient(135deg, var(--caribbean-current), var(--moonstone));
            color: var(--isabelline);
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(22, 105, 122, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(22, 105, 122, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--caribbean-current), var(--moonstone));
        }
        
        .btn-secondary {
            background: var(--sky-blue);
            color: var(--caribbean-current);
        }
        
        .hidden {
            display: none;
        }
        
        .result {
            margin: 25px 0;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid;
        }
        
        .success {
            background: rgba(130, 192, 204, 0.2);
            border-color: var(--caribbean-current);
            border-left-width: 5px;
        }
        
        .error {
            background: rgba(255, 166, 43, 0.2);
            border-color: var(--orange-peel);
            border-left-width: 5px;
        }
        
        .info {
            background: rgba(130, 192, 204, 0.2);
            border-color: var(--sky-blue);
            border-left-width: 5px;
        }
        
        .student-card {
            background: var(--isabelline);
            border: 2px solid var(--sky-blue);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            transition: transform 0.2s ease;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }
        
        .service-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--isabelline);
            border: 2px solid var(--sky-blue);
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .service-checkbox:hover {
            border-color: var(--moonstone);
            background: rgba(130, 192, 204, 0.1);
        }
        
        .service-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }
        
        .loading {
            text-align: center;
            padding: 60px 40px;
        }
        
        .spinner {
            border: 4px solid rgba(130, 192, 204, 0.3);
            border-top: 4px solid var(--caribbean-current);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .record-item {
            border-bottom: 2px solid var(--sky-blue);
            padding: 20px 0;
            margin: 15px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: start;
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        .record-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .info-line {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
        }
        
        .info-label {
            font-weight: 600;
            color: var(--caribbean-current);
            min-width: 80px;
            font-size: 14px;
        }
        
        .info-value {
            color: var(--caribbean-current);
            flex: 1;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: flex-start;
        }
        
        .visit-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--sky-blue);
        }
        
        .visit-number {
            background: var(--caribbean-current);
            color: var(--isabelline);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Dental Chart Styles */
        .dental-chart {
            margin: 20px 0;
            padding: 15px;
            background: var(--isabelline);
            border: 2px solid var(--sky-blue);
            border-radius: 10px;
        }
        
        .chart-section {
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--caribbean-current);
            text-align: center;
        }
        
        .quadrant-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .quadrant {
            padding: 10px;
            border: 1px solid var(--sky-blue);
            border-radius: 8px;
            background: var(--isabelline);
        }
        
        .quadrant-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: var(--caribbean-current);
        }
        
        .tooth-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .tooth-label {
            font-weight: bold;
            width: 30px;
            text-align: center;
            color: var(--caribbean-current);
        }
        
        .tooth-input {
            width: 50px;
            text-align: center;
            border: 1px solid var(--sky-blue);
            border-radius: 4px;
            padding: 2px 5px;
            color: var(--caribbean-current);
            background: var(--isabelline);
        }
        
        .oral-health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .oral-health-item {
            padding: 10px;
            border: 1px solid var(--sky-blue);
            border-radius: 8px;
            background: var(--isabelline);
        }
        
        .oral-health-question {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--caribbean-current);
        }
        
        .progress-dashboard { margin: 15px 0; }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .metric-card { background: var(--isabelline); padding: 15px; border-radius: 8px; border-left: 4px solid var(--sky-blue); text-align: center; }
        .metric-card.success { border-left-color: var(--caribbean-current); background: rgba(130, 192, 204, 0.2); }
        .metric-card.info { border-left-color: var(--moonstone); background: rgba(130, 192, 204, 0.2); }
        .metric-value { font-size: 24px; font-weight: bold; margin: 5px 0; color: var(--caribbean-current); }
        .timeline { border-left: 2px solid var(--sky-blue); margin-left: 10px; padding-left: 20px; }
        .timeline-item { margin: 15px 0; padding: 10px; border-radius: 5px; background: var(--isabelline); }
        .timeline-marker { font-weight: bold; margin-bottom: 5px; color: var(--caribbean-current); }
        .priority-emergency { background: rgba(255, 166, 43, 0.2); border-left: 4px solid var(--orange-peel); }
        .priority-high { background: rgba(169, 74, 74, 0.2); border-left: 4px solid #A94A4A; }
        .priority-medium { background: rgba(130, 192, 204, 0.2); border-left: 4px solid var(--moonstone); }
        .priority-low { background: rgba(130, 192, 204, 0.2); border-left: 4px solid var(--sky-blue); }
        .recommendations-section ul { list-style: none; padding: 0; }
        .recommendations-section li { padding: 8px; margin: 5px 0; background: rgba(130, 192, 204, 0.2); border-radius: 5px; color: var(--caribbean-current); }
        .highlight { background: linear-gradient(120deg, rgba(130, 192, 204, 0) 0%, rgba(130, 192, 204, 0.4) 100%); padding: 3px 6px; border-radius: 4px; color: var(--caribbean-current); }
        
        /* Dental Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: var(--isabelline);
            border: 2px solid var(--sky-blue);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--caribbean-current);
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--caribbean-current);
            text-transform: uppercase;
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 25px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .services-grid {
                grid-template-columns: 1fr;
            }
            
            .record-item {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .quadrant-grid {
                grid-template-columns: 1fr;
            }
            
            .oral-health-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Student Dental Records</h1>
            <p>Complete Dental Examination System with FDI Charting</p>
        </div>
        
        <div class="content">
            <!-- Search Section -->
            <div id="searchSection">
                <h2>Search Student Records</h2>
                <form id="searchForm">
                    <div class="form-group">
                        <label for="completeName">Complete Name of Pupil / Kumpletong Ngalan ng Mag-aaral</label>
                        <input type="text" id="completeName" name="completeName" required placeholder="Enter student's complete name">
                    </div>
                    
                    <div class="form-group">
                        <label for="dob">Date of Birth / Petsa ng kapanganakan</label>
                        <input type="text" id="dob" name="dob" required placeholder="DD/MM/YYYY">
                    </div>
                    
                    <div class="form-group">
                        <label for="school">School / Paaralan</label>
                        <select id="school" name="school" required>
                            <option value="">Select School</option>
                            <option value="JCES">JCES</option>
                            <option value="Boctol">Boctol</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn">
                            <span>üîç</span>
                            Search Records
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loading Section -->
            <div id="loadingSection" class="hidden">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Searching Student Records...</h3>
                    <p>Please wait while we search our database</p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <div id="resultsContent"></div>
                <div class="action-buttons" style="justify-content: center; margin-top: 30px;">
                    <button onclick="resetSearch()" class="btn btn-secondary">
                        <span>üîÑ</span>
                        Search Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRecords = [];
        let currentStudent = null;

        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            searchStudent();
        });

        function searchStudent() {
            document.getElementById('searchSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');
            
            const formData = new FormData(document.getElementById('searchForm'));
            
            google.script.run
                .withSuccessHandler(handleSearchResult)
                .withFailureHandler(handleSearchError)
                .checkStudent(
                    formData.get('completeName'),
                    formData.get('dob'),
                    formData.get('school')
                );
        }

        function handleSearchResult(result) {
            console.log('Search result received:', result);
            
            if (!result) {
                showError('The search returned no response. Please try again.');
                return;
            }
            
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            const resultsContent = document.getElementById('resultsContent');
            currentRecords = (result.records || []);
            
            let html = '';

            if (result.success === false) {
                html = `
                    <div class="result error">
                        <h3>‚ùå Error</h3>
                        <p>${result.error || 'Unknown error occurred'}</p>
                    </div>
                `;
            } 
            else if (result.found && currentRecords.length > 0) {
                currentStudent = currentRecords[0];
                
                html = `
                    <div class="result success">
                        <h3>‚úÖ Student Found!</h3>
                        <p>Found <span class="highlight">${result.count}</span> record(s) for <strong>${currentStudent.completeName || ''}</strong></p>
                    </div>
                `;

                // Show previous records
                if (currentRecords.length > 0) {
                    html += `
                        <div class="student-card">
                            <div class="visit-header">
                                <h4>üìã Visit History</h4>
                                <span class="visit-number">${currentRecords.length} visits</span>
                            </div>
                    `;
                    
                    currentRecords.forEach((record, index) => {
                        html += `
                            <div class="record-item">
                                <div class="record-info">
                                    <div class="info-line">
                                        <span class="info-label">Visit:</span>
                                        <span class="info-value">${index + 1} ‚Ä¢ ${formatDate(record.timestamp) || 'No date'}</span>
                                    </div>
                                    <div class="info-line">
                                        <span class="info-label">School:</span>
                                        <span class="info-value">${record.school || 'Not specified'}</span>
                                    </div>
                                    <div class="info-line">
                                        <span class="info-label">Age:</span>
                                        <span class="info-value">${record.age || 'Not specified'}</span>
                                    </div>
                                    <div class="info-line">
                                        <span class="info-label">Sex:</span>
                                        <span class="info-value">${record.sex || 'Not specified'}</span>
                                    </div>
                                </div>
                                <div class="record-info">
                                    <div class="info-line">
                                        <span class="info-label">Parent:</span>
                                        <span class="info-value">${record.parentName || 'Not specified'}</span>
                                    </div>
                                    <div class="info-line">
                                        <span class="info-label">Contact:</span>
                                        <span class="info-value">${record.contactNumber || 'Not specified'}</span>
                                    </div>
                                    <div class="info-line">
                                        <span class="info-label">Procedures:</span>
                                        <span class="info-value">${record.dentalProcedures || 'None'}</span>
                                    </div>
                                    <div class="info-line">
                                        <span class="info-label">Remarks:</span>
                                        <span class="info-value">${record.remarks || 'No remarks'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // Add dental examination form
                html += createDentalExaminationForm(currentStudent);

                // Add progress tracking section container
                html += `
                    <div id="progressSection" class="student-card hidden">
                        <h4>üìä Patient Progress Tracking</h4>
                        <div id="progressContent"></div>
                    </div>
                `;
            }
            else {
                html = `
                    <div class="result error">
                        <h3>‚ùå Student Not Found</h3>
                        <p>${result.message || 'No dental records found for this student.'}</p>
                        <div class="action-buttons">
                            <a href="https://docs.google.com/forms/d/e/1FAIpQLSfCr7xCoPlHJ_dEXUEeLUDIaXhHRyZ75cpfY8Nj1gRowyEcZQ/viewform?usp=sharing&ouid=101834401401409938264" 
                               target="_blank" class="btn btn-success">
                                <span>üìù</span>
                                Register New Student
                            </a>
                        </div>
                    </div>
                `;
            }

            resultsContent.innerHTML = html;
            if (result.found && currentRecords.length > 0 && result.progress) {
                displayProgressData(
                    result.progress, 
                    result.priorityHistory || [], 
                    result.servicesHistory || [], 
                    result.totalVisits || currentRecords.length
                );
            }
        }

        function createDentalExaminationForm(student) {
            const safeStudent = student || {};
            return `
                <div class="student-card">
                    <h4>ü¶∑ Complete Dental Examination</h4>
                    <form id="dentalExamForm">
                        <!-- Medical Information -->
                        <div class="form-group">
                            <label for="systemicConditions">Systemic Conditions / Sistemikong karamdaman</label>
                            <input type="text" id="systemicConditions" name="systemicConditions" value="${safeStudent.systemicConditions || ''}" placeholder="Enter systemic conditions">
                        </div>
                        
                        <div class="form-group">
                            <label for="allergiesFood">Allergies (Food & Environment) / Allergy (Pagkain at Kapaligiran)</label>
                            <input type="text" id="allergiesFood" name="allergiesFood" value="${safeStudent.allergiesFood || ''}" placeholder="Enter food or environmental allergies">
                        </div>
                        
                        <div class="form-group">
                            <label for="allergiesMedicines">Allergies (Medicines) / Allergy (Mga Gamot)</label>
                            <input type="text" id="allergiesMedicines" name="allergiesMedicines" value="${safeStudent.allergiesMedicines || ''}" placeholder="Enter medicine allergies">
                        </div>
                        
                        <!-- Tooth Extraction -->
                        <div class="form-group">
                            <label for="toothExtraction">Tooth Extraction (FDI numbers, separate by commas) / Pagbunot ng Ngipin (ilagay ang FDI number, paghiwalayin gamit ang kuwit)</label>
                            <input type="text" id="toothExtraction" name="toothExtraction" placeholder="e.g., 18, 24, 36, 48">
                        </div>
                        
                        <!-- Tooth Filling -->
                        <div class="form-group">
                            <label for="toothFilling">Tooth Filling (FDI numbers, separate by commas) / Pagpasta ng Ngipin (ilagay ang FDI number, paghiwalayin gamit ang kuwit)</label>
                            <input type="text" id="toothFilling" name="toothFilling" placeholder="e.g., 16, 26, 46">
                        </div>
                        
                        <!-- Cleaning -->
                        <div class="form-group">
                            <label for="cleaning">Cleaning (FDI numbers, separate by commas) / Paglilinis (ilagay ang FDI number, paghiwalayin gamit ang kuwit)</label>
                            <input type="text" id="cleaning" name="cleaning" placeholder="e.g., 11-18, 21-28">
                        </div>
                        
                        <div class="form-group">
                            <label for="cleaningNotes">Cleaning Notes / Paglilinis (Mga Tala)</label>
                            <textarea id="cleaningNotes" name="cleaningNotes" rows="2" placeholder="Enter cleaning notes..."></textarea>
                        </div>
                        
                        <!-- Fluoride -->
                        <div class="form-group">
                            <label for="fluoride">Fluoride</label>
                            <select id="fluoride" name="fluoride">
                                <option value="">Select</option>
                                <option value="Oo">Oo</option>
                                <option value="Hindi">Hindi</option>
                            </select>
                        </div>
                        
                        <!-- Dental Consultations -->
                        <div class="form-group">
                            <label for="dentalConsultations">Dental Consultations / Konsultasyon sa Ngipin</label>
                            <select id="dentalConsultations" name="dentalConsultations">
                                <option value="">Select</option>
                                <option value="Oo">Oo</option>
                                <option value="Hindi">Hindi</option>
                            </select>
                        </div>
                        
                        <!-- Severe Childhood Cavities -->
                        <div class="form-group">
                            <label for="severeCavities">Severe Childhood Cavities / Malubhang Karies sa Bata</label>
                            <select id="severeCavities" name="severeCavities">
                                <option value="">Select</option>
                                <option value="Oo">Oo</option>
                                <option value="Hindi">Hindi</option>
                            </select>
                        </div>
                        
                        <!-- Dental Procedures -->
                        <div class="form-group">
                            <label>Dental Procedures / Mga Pamamaraan sa Ngipin</label>
                            <div class="services-grid">
                                <label class="service-checkbox">
                                    <input type="checkbox" name="procedures" value="Extraction">
                                    <span>Extraction / Pagbunot</span>
                                </label>
                                <label class="service-checkbox">
                                    <input type="checkbox" name="procedures" value="Filling">
                                    <span>Filling / Pagpasta</span>
                                </label>
                                <label class="service-checkbox">
                                    <input type="checkbox" name="procedures" value="Cleaning">
                                    <span>Cleaning / Paglilinis</span>
                                </label>
                                <label class="service-checkbox">
                                    <input type="checkbox" name="procedures" value="Fluoride">
                                    <span>Fluoride</span>
                                </label>
                                <label class="service-checkbox">
                                    <input type="checkbox" name="procedures" value="Consultation">
                                    <span>Consultation / Konsultasyon</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Oral Exam Notes -->
                        <div class="form-group">
                            <label for="oralExamNotes">Oral Exam Notes / Pagsusuri sa Ngipin (Mga Tala)</label>
                            <textarea id="oralExamNotes" name="oralExamNotes" rows="3" placeholder="Enter oral examination findings..."></textarea>
                        </div>
                        
                        <!-- Dental Hygiene Questions -->
                        <div class="oral-health-grid">
                            <div class="oral-health-item">
                                <div class="oral-health-question">Do you have a toothbrush? / Mayroon ka bang sipilyo?</div>
                                <select name="hasToothbrush">
                                    <option value="">Select</option>
                                    <option value="Oo">Oo</option>
                                    <option value="Hindi">Hindi</option>
                                </select>
                            </div>
                            <div class="oral-health-item">
                                <div class="oral-health-question">How many times do you brush your teeth? / Ilang beses ka magsipilyo</div>
                                <input type="text" name="brushFrequency" placeholder="e.g., 2 beses">
                            </div>
                            <div class="oral-health-item">
                                <div class="oral-health-question">How many times do you change your toothbrush in a year? / Ilang beses ka magpalit ng sipilyo sa isang taon?</div>
                                <input type="text" name="toothbrushChanges" placeholder="e.g., 4 na beses">
                            </div>
                            <div class="oral-health-item">
                                <div class="oral-health-question">Do you use toothpaste in brushing? / Gumagamit ka ba ng toothpaste kapag nagsisipilyo?</div>
                                <select name="usesToothpaste">
                                    <option value="">Select</option>
                                    <option value="Oo">Oo</option>
                                    <option value="Hindi">Hindi</option>
                                </select>
                            </div>
                            <div class="oral-health-item">
                                <div class="oral-health-question">How many times do you visit the dentist in a year? / Ilang beses ka pumunta sa dentista sa isang taon?</div>
                                <input type="text" name="dentalVisits" placeholder="e.g., 2 beses">
                            </div>
                        </div>
                        
                        <!-- Remarks -->
                        <div class="form-group">
                            <label for="remarks">Remarks / Mga Puna</label>
                            <textarea id="remarks" name="remarks" rows="3" placeholder="Enter remarks..."></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">
                                <span>üíæ</span>
                                Save Complete Dental Record
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function displayProgressData(progress, priorityHistory, servicesHistory, totalVisits) {
            const progressContent = document.getElementById('progressContent');
            
            if (!progress.hasEnoughData) {
                progressContent.innerHTML = `
                    <div class="result info">
                        <p>${progress.message}</p>
                        <p><strong>Total Visits:</strong> ${totalVisits}</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="progress-dashboard">
                    <div class="progress-metrics">
                        <h5>üìà Progress Overview</h5>
                        <div class="metric-grid">
                            <div class="metric-card ${progress.priorityImprovement.improved ? 'success' : 'info'}">
                                <strong>Priority Trend</strong>
                                <div class="metric-value">${progress.priorityImprovement.message}</div>
                                <small>${progress.firstVisit.priority} ‚Üí ${progress.lastVisit.priority}</small>
                            </div>
                            <div class="metric-card">
                                <strong>Total Visits</strong>
                                <div class="metric-value">${progress.totalVisits}</div>
                                <small>First: ${formatDate(progress.firstVisit.date)}</small>
                            </div>
                            <div class="metric-card">
                                <strong>Recent Services</strong>
                                <div class="metric-value">${progress.servicesSummary.recentServices.length}</div>
                                <small>${progress.servicesSummary.preventiveServices} preventive</small>
                            </div>
                        </div>
                    </div>
            `;
            
            // Priority History Timeline
            if (priorityHistory.length > 0) {
                html += `
                    <div class="timeline-section">
                        <h5>üïí Priority History</h5>
                        <div class="timeline">
                `;
                priorityHistory.forEach((visit, index) => {
                    const priorityClass = getPriorityClass(visit.priority);
                    html += `
                        <div class="timeline-item ${priorityClass}">
                            <div class="timeline-marker">Visit ${visit.visit}</div>
                            <div class="timeline-content">
                                <strong>${visit.priority}</strong>
                                <div>${formatDate(visit.date)}</div>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            // Recommendations
            if (progress.recommendations && progress.recommendations.length > 0) {
                html += `
                    <div class="recommendations-section">
                        <h5>üí° Recommendations</h5>
                        <ul>
                `;
                progress.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += `</ul></div>`;
            }
            
            html += `</div>`;
            progressContent.innerHTML = html;
            document.getElementById('progressSection').classList.remove('hidden');
        }

        function getPriorityClass(priority) {
            const classes = {
                'Emergency': 'priority-emergency',
                'High': 'priority-high',
                'Medium': 'priority-medium',
                'Low': 'priority-low'
            };
            return classes[priority] || 'priority-unknown';
        }

        function showError(message) {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsContent').innerHTML = `
                <div class="result error">
                    <h3>‚ùå Error</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        document.addEventListener('submit', function(e) {
            if (e.target.id === 'dentalExamForm') {
                e.preventDefault();
                saveDentalExam();
            }
        });

        function saveDentalExam() {
            if (!currentStudent) {
                alert('‚ùå No student record available to update');
                return;
            }

            const formData = new FormData(document.getElementById('dentalExamForm'));
            
            // Collect selected procedures
            const selectedProcedures = [];
            document.querySelectorAll('input[name="procedures"]:checked').forEach(checkbox => {
                selectedProcedures.push(checkbox.value);
            });

            const examData = {
                systemicConditions: formData.get('systemicConditions'),
                allergiesFood: formData.get('allergiesFood'),
                allergiesMedicines: formData.get('allergiesMedicines'),
                toothExtraction: formData.get('toothExtraction'),
                toothFilling: formData.get('toothFilling'),
                cleaning: formData.get('cleaning'),
                cleaningNotes: formData.get('cleaningNotes'),
                fluoride: formData.get('fluoride'),
                dentalConsultations: formData.get('dentalConsultations'),
                severeCavities: formData.get('severeCavities'),
                dentalProcedures: selectedProcedures,
                oralExamNotes: formData.get('oralExamNotes'),
                hasToothbrush: formData.get('hasToothbrush'),
                brushFrequency: formData.get('brushFrequency'),
                toothbrushChanges: formData.get('toothbrushChanges'),
                usesToothpaste: formData.get('usesToothpaste'),
                dentalVisits: formData.get('dentalVisits'),
                remarks: formData.get('remarks')
            };

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result && result.success) {
                        alert('‚úÖ ' + result.message);
                        document.getElementById('dentalExamForm').reset();
                    } else {
                        alert('‚ùå Error: ' + (result ? result.error : 'Unknown error'));
                    }
                })
                .withFailureHandler(function(error) {
                    alert('‚ùå Save failed: ' + error.message);
                })
                .saveDentalExam(currentStudent, examData);
        }

        function handleSearchError(error) {
            console.error('Search error:', error);
            showError('Connection error: ' + error.message);
        }

        function resetSearch() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('searchSection').classList.remove('hidden');
        }

        function formatDate(dateValue) {
            if (!dateValue) return 'Not specified';
            if (typeof dateValue === 'string') {
                try {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('en-GB');
                    }
                } catch (e) {
                }
                return dateValue;
            }
            if (dateValue instanceof Date) {
                return dateValue.toLocaleDateString('en-GB');
            }
            return String(dateValue);
        }
        function sendHeightToParent() {
    const height = document.body.scrollHeight;
    window.parent.postMessage({ type: 'resize-iframe', height: height }, '*');
}
      window.addEventListener('load', sendHeightToParent);
      window.addEventListener('resize', sendHeightToParent);
      const observer = new MutationObserver(sendHeightToParent);
      observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>
